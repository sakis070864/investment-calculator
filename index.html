<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Υπολογιστής Επένδυσης Ακινήτων</title>
    
    <!-- Favicon: Light Blue House Icon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2360a5fa'%3E%3Cpath d='M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3z'/%3E%3C/svg%3E" type="image/svg+xml">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        .input-group:focus-within label { color: #4f46e5; }
        .input-group:focus-within input { border-color: #4f46e5; ring: 2px; }
        .required::after { content: " *"; color: #ef4444; }
        
        /* Error state class for validation */
        .input-error {
            border-color: #ef4444 !important;
            background-color: #fef2f2;
        }

        /* Strength Meter Gradient */
        .strength-gradient {
            background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #22c55e 100%);
        }

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }

        /* Modal Styles */
        .modal {
            transition: opacity 0.25s ease;
        }
        body.modal-active {
            overflow-x: hidden;
            overflow-y: visible !important;
        }
        /* Custom scrollbar for table */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-6">
                <div class="inline-flex p-3 bg-indigo-100 rounded-full mb-4">
                    <i data-lucide="lock" class="w-8 h-8 text-indigo-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Είσοδος</h2>
                <p class="text-gray-500 text-sm mt-1">Απαιτείται εξουσιοδότηση για πρόσβαση</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="loginEmail" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-indigo-500 focus:outline-none transition-all" placeholder="name@example.com" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Κωδικός</label>
                    <input type="password" id="loginPassword" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-indigo-500 focus:outline-none transition-all" placeholder="••••••••" required>
                </div>
                <div id="loginError" class="p-3 bg-red-50 text-red-600 text-sm rounded-lg hidden flex items-center gap-2">
                    <i data-lucide="alert-circle" class="w-4 h-4"></i>
                    <span id="loginErrorText">Λάθος στοιχεία.</span>
                </div>
                <button type="submit" id="loginBtnSubmit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition-colors shadow-md flex justify-center items-center gap-2">
                    <span>Σύνδεση</span>
                </button>
            </form>
        </div>
    </div>

    <!-- MAIN APP CONTENT (Hidden by default) -->
    <div id="app-content" class="hidden w-full flex-col min-h-screen p-4 md:p-8">

        <!-- Toast Notification Container -->
        <div id="toast" class="flex items-center justify-center gap-2 shadow-xl bg-slate-800">
            <span id="toast-icon-container"><i data-lucide="check-circle" class="text-green-400 w-5 h-5"></i></span>
            <span id="toast-message">Το project αποθηκεύτηκε επιτυχώς!</span>
        </div>

        <!-- INFO MODAL (NEW) -->
        <div id="infoModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[70]">
            <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
            <div class="modal-container bg-white w-11/12 md:max-w-lg mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto">
                <div class="modal-content py-4 text-left px-6">
                    <div class="flex justify-between items-center pb-3 border-b">
                        <p class="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <i data-lucide="info" class="w-6 h-6 text-indigo-600"></i>
                            Ταυτότητα Εφαρμογής
                        </p>
                        <div class="cursor-pointer z-50 p-1 hover:bg-gray-100 rounded-full" id="closeInfoModalX">
                            <i data-lucide="x" class="w-5 h-5 text-gray-600"></i>
                        </div>
                    </div>
                    <div class="my-5 space-y-4">
                        <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <p class="text-xs text-gray-500 uppercase font-semibold">Εφαρμογη</p>
                            <p class="text-gray-900 font-medium">Real Estate Investment Calculator <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded-full ml-2">v1.0.0</span></p>
                        </div>

                        <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <p class="text-xs text-gray-500 uppercase font-semibold">GitHub Repository (Code)</p>
                            <a href="https://github.com/sakis070864/investment-calculator" target="_blank" class="text-blue-600 hover:text-blue-800 flex items-center gap-1 break-all text-sm mt-1">
                                <i data-lucide="github" class="w-4 h-4"></i> sakis070864/investment-calculator
                            </a>
                        </div>

                        <div class="grid grid-cols-1 gap-2">
                            <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                                <p class="text-xs text-gray-500 uppercase font-semibold">Vercel Deployment (Live)</p>
                                <a href="https://oikodomi.vercel.app" target="_blank" class="text-green-600 hover:text-green-800 flex items-center gap-1 break-all text-sm mt-1">
                                    <i data-lucide="globe" class="w-4 h-4"></i> https://oikodomi.vercel.app
                                </a>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                                <p class="text-xs text-gray-500 uppercase font-semibold">Vercel Project Name (Dashboard)</p>
                                <p class="text-gray-900 font-mono text-sm mt-1 flex items-center gap-2">
                                    <i data-lucide="layout-grid" class="w-4 h-4 text-gray-500"></i> investment-calculator
                                </p>
                            </div>
                        </div>

                        <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <p class="text-xs text-gray-500 uppercase font-semibold">Firebase Project ID</p>
                            <p class="text-gray-900 font-mono text-sm mt-1">sakisathan-28c2e</p>
                        </div>

                        <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <p class="text-xs text-gray-500 uppercase font-semibold">Tech Stack</p>
                            <div class="flex flex-wrap gap-2 mt-2">
                                <span class="px-2 py-1 bg-white border border-gray-300 rounded text-xs">HTML5</span>
                                <span class="px-2 py-1 bg-white border border-gray-300 rounded text-xs">Tailwind CSS</span>
                                <span class="px-2 py-1 bg-white border border-gray-300 rounded text-xs">Firebase (Auth & Firestore)</span>
                                <span class="px-2 py-1 bg-white border border-gray-300 rounded text-xs">Chart.js</span>
                            </div>
                        </div>
                        
                        <div class="text-center pt-2">
                            <p class="text-xs text-gray-400">Developer: Thanasis Athanasopoulos</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- HISTORY MODAL -->
        <div id="historyModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
            <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
            
            <div class="modal-container bg-white w-11/12 md:max-w-7xl mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto max-h-[90vh]">
                
                <!-- Modal Header -->
                <div class="modal-content py-4 text-left px-6">
                    <div class="flex justify-between items-center pb-3 border-b">
                        <p class="text-2xl font-bold text-gray-800">Ιστορικό Έργων</p>
                        <div class="modal-close cursor-pointer z-50 p-2 hover:bg-gray-100 rounded-full">
                            <i data-lucide="x" class="w-6 h-6 text-gray-600"></i>
                        </div>
                    </div>

                    <!-- Modal Body (Table) -->
                    <div class="my-5 overflow-x-auto custom-scroll">
                        <table class="min-w-full leading-normal">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Project / Διεύθυνση</th>
                                    <th class="px-4 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Ημ/νία</th>
                                    <th class="px-4 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">m² Οικοπ.</th>
                                    <th class="px-4 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Τιμή Αγοράς</th>
                                    <th class="px-4 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Σ.Δ.</th>
                                    <th class="px-4 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Κόστος/m²</th>
                                    <th class="px-4 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Πώληση/m²</th>
                                    <th class="px-4 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Ολικό Κόστος</th>
                                    <th class="px-4 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Συν. Κέρδος</th>
                                    <th class="px-4 py-3 border-b-2 border-gray-200 bg-gray-100 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Ενέργεια</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- Rows will be populated by JS -->
                            </tbody>
                        </table>
                        <div id="loadingHistory" class="text-center py-10 hidden">
                            <i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto text-indigo-600"></i>
                            <p class="text-gray-500 mt-2">Φόρτωση δεδομένων...</p>
                        </div>
                        <div id="emptyHistory" class="text-center py-10 hidden">
                            <p class="text-gray-500">Δεν βρέθηκαν αποθηκευμένα έργα.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DELETE CONFIRMATION MODAL -->
        <div id="deleteModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[60]">
            <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
            <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-2xl z-50 overflow-y-auto">
                <div class="modal-content py-4 text-left px-6">
                    <div class="flex justify-between items-center pb-3 border-b">
                        <p class="text-lg font-bold text-gray-800">Διαγραφή Εγγραφής</p>
                        <div class="cursor-pointer z-50 p-1 hover:bg-gray-100 rounded-full" id="closeDeleteModalX">
                            <i data-lucide="x" class="w-5 h-5 text-gray-600"></i>
                        </div>
                    </div>
                    <div class="my-5">
                        <p class="text-gray-600">Είστε σίγουροι ότι θέλετε να διαγράψετε οριστικά αυτό το project;</p>
                        <p class="text-sm text-red-500 mt-1">Η ενέργεια αυτή δεν μπορεί να αναιρεθεί.</p>
                    </div>
                    <div class="flex justify-end gap-3 pt-2">
                        <button id="cancelDeleteBtn" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg text-sm font-medium transition-colors">
                            Άκυρο
                        </button>
                        <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium shadow-md transition-colors flex items-center gap-2">
                            <span>Διαγραφή</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Header -->
        <header class="max-w-7xl mx-auto mb-8 w-full flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <div class="p-3 bg-indigo-600 rounded-lg text-white shadow-lg">
                    <i data-lucide="calculator" class="w-7 h-7"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-indigo-900">Υπολογιστής Επένδυσης</h1>
                    <div class="flex items-center gap-2">
                        <p class="text-slate-500 text-sm">Active Project:</p>
                        <span id="activeProjectIndicator" class="text-xs font-bold px-2 py-1 bg-gray-200 text-gray-600 rounded">Κανένα</span>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex gap-3">
                <button id="resetBtn" class="flex items-center gap-2 bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 font-semibold py-2 px-6 rounded-lg shadow-sm transition-colors" title="Επαναφορά φορμας">
                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                    <span class="hidden md:inline">Καθαρισμός</span>
                </button>

                <button id="historyBtn" class="flex items-center gap-2 bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 font-semibold py-2 px-6 rounded-lg shadow-sm transition-colors disabled:opacity-50">
                    <i data-lucide="history" class="w-4 h-4"></i>
                    <span class="hidden md:inline">Ιστορικό</span>
                </button>
                
                <button id="saveBtn" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-lucide="save" class="w-4 h-4"></i>
                    <span class="hidden md:inline">Αποθήκευση</span>
                </button>

                <div class="w-px bg-gray-300 mx-1"></div>

                <button id="logoutBtn" class="flex items-center gap-2 bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 font-semibold py-2 px-4 rounded-lg shadow-sm transition-colors" title="Αποσύνδεση">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                </button>
            </div>
        </header>

        <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6 w-full flex-grow">
            
            <!-- Left Column: Inputs -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- Plot Details Card -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <i data-lucide="map-pin" class="text-indigo-600 w-5 h-5"></i>
                        Ταυτότητα Ακινήτου
                    </h2>
                    
                    <div class="space-y-4 mb-6 pb-6 border-b border-gray-100">
                        <div class="input-group">
                            <label class="block text-sm font-medium text-gray-700 mb-1 required">Στοιχεία Οικοπέδου / Ονομασία</label>
                            <input type="text" id="projectName" placeholder="π.χ. Οικόπεδο Γλυφάδα" class="w-full border-gray-300 border rounded-md p-2 focus:outline-none focus:border-indigo-500 transition shadow-sm">
                        </div>
                        
                        <div class="space-y-2">
                            <!-- Row 1: Street & Number -->
                            <div class="grid grid-cols-12 gap-2">
                                <div class="col-span-8 input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Οδός</label>
                                    <input type="text" id="addrStreet" placeholder="Ερμού" class="address-input w-full border-gray-300 border rounded-md p-2 focus:outline-none focus:border-indigo-500 transition shadow-sm">
                                </div>
                                <div class="col-span-4 input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Αρ.</label>
                                    <input type="text" id="addrNum" placeholder="10" class="address-input w-full border-gray-300 border rounded-md p-2 focus:outline-none focus:border-indigo-500 transition shadow-sm">
                                </div>
                            </div>

                            <!-- Row 2: Area & Municipality -->
                            <div class="grid grid-cols-12 gap-2">
                                <div class="col-span-6 input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Περιοχή</label>
                                    <input type="text" id="addrArea" placeholder="Κέντρο" class="address-input w-full border-gray-300 border rounded-md p-2 focus:outline-none focus:border-indigo-500 transition shadow-sm">
                                </div>
                                <div class="col-span-6 input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Δήμος</label>
                                    <input type="text" id="addrDimos" placeholder="Δ. Αθηναίων" class="address-input w-full border-gray-300 border rounded-md p-2 focus:outline-none focus:border-indigo-500 transition shadow-sm">
                                </div>
                            </div>
                        </div>

                        <!-- Google Map Container -->
                        <div class="mt-2 rounded-lg overflow-hidden border border-gray-200 shadow-inner bg-gray-100 h-48 relative group">
                            <iframe 
                                id="gmap_canvas"
                                width="100%" 
                                height="100%" 
                                frameborder="0" 
                                scrolling="no" 
                                marginheight="0" 
                                marginwidth="0" 
                                src="https://maps.google.com/maps?q=Greece&t=&z=5&ie=UTF8&iwloc=&output=embed">
                            </iframe>
                            <div class="absolute inset-0 pointer-events-none border-4 border-transparent group-hover:border-indigo-100 transition-all"></div>
                        </div>
                    </div>

                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <i data-lucide="home" class="text-indigo-600 w-5 h-5"></i>
                        Μετρήσεις & Όροι
                    </h2>

                    <div class="space-y-4">
                        <div class="input-group">
                            <label class="block text-sm font-medium text-gray-700 mb-1 required">Εμβαδόν Οικοπέδου (m²)</label>
                            <input type="number" id="plotSize" value="" class="w-full border-gray-300 border rounded-md p-2 focus:outline-none focus:border-indigo-500 transition shadow-sm">
                        </div>

                        <div class="input-group">
                            <label class="block text-sm font-medium text-gray-700 mb-1 required">Τιμή Αγοράς Οικοπέδου (€)</label>
                            <input type="number" id="plotPrice" value="" step="1000" class="w-full border-gray-300 border rounded-md p-2 focus:outline-none focus:border-indigo-500 transition shadow-sm">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="input-group">
                                <label class="block text-sm font-medium text-gray-700 mb-1 required">Σ.Δ (π.χ. 0.8)</label>
                                <input type="number" id="buildFactor" value="" step="0.1" class="w-full border-gray-300 border rounded-md p-2 focus:outline-none focus:border-indigo-500 transition shadow-sm">
                            </div>
                            <div class="input-group">
                                <label class="block text-sm font-medium text-gray-700 mb-1 required">Κάλυψη (%)</label>
                                <input type="number" id="coverageFactor" value="" class="w-full border-gray-300 border rounded-md p-2 focus:outline-none focus:border-indigo-500 transition shadow-sm">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Financial Details Card -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <i data-lucide="dollar-sign" class="text-green-600 w-5 h-5"></i>
                        Οικονομικά Στοιχεία
                    </h2>
                    <div class="space-y-4">
                        <div class="input-group">
                            <label class="block text-sm font-medium text-gray-700 mb-1 required">Κόστος Κατασκευής (€/m²)</label>
                            <input type="number" id="costPerSqm" value="" class="w-full border-gray-300 border rounded-md p-2 focus:outline-none focus:border-indigo-500 transition shadow-sm">
                        </div>

                        <div class="input-group">
                            <label class="block text-sm font-medium text-gray-700 mb-1 required">Τιμή Πώλησης (€/m²)</label>
                            <input type="number" id="sellPricePerSqm" value="" class="w-full border-gray-300 border rounded-md p-2 focus:outline-none focus:border-indigo-500 transition shadow-sm">
                        </div>
                    </div>
                </div>

            </div>

            <!-- Right Column: Results & Charts -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- KPI Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white p-5 rounded-lg shadow border-l-4 border-orange-500 flex items-center">
                        <div class="p-3 rounded-full bg-orange-50 mr-4">
                            <i data-lucide="activity" class="text-orange-600 w-6 h-6"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Συνολική Επένδυση</p>
                            <p class="text-lg font-bold text-gray-900" id="res-totalInvestment">€0</p>
                        </div>
                    </div>
                    <div class="bg-white p-5 rounded-lg shadow border-l-4 border-blue-500 flex items-center">
                        <div class="p-3 rounded-full bg-blue-50 mr-4">
                            <i data-lucide="trending-up" class="text-blue-600 w-6 h-6"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Συνολικά Έσοδα</p>
                            <p class="text-lg font-bold text-gray-900" id="res-totalRevenue">€0</p>
                        </div>
                    </div>
                    <div class="bg-white p-5 rounded-lg shadow border-l-4 border-green-500 flex items-center">
                        <div class="p-3 rounded-full bg-green-50 mr-4">
                            <i data-lucide="banknote" class="text-green-600 w-6 h-6"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Καθαρό Κέρδος</p>
                            <p class="text-lg font-bold text-gray-900" id="res-grossProfit">€0</p>
                        </div>
                    </div>
                </div>

                <!-- Unit Analysis Stats -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-slate-800 text-white p-5 rounded-lg shadow flex justify-between items-center">
                        <div>
                            <p class="text-slate-400 text-xs font-bold uppercase tracking-wider">Τελικο Κοστος / m²</p>
                            <p class="text-xs text-slate-400 mt-1">(Γη + Κατασκευή)</p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-orange-400" id="res-finalCostPerSqm">€0</p>
                            <p class="text-xs text-slate-400">ανά δομήσιμο μέτρο</p>
                        </div>
                    </div>
                    <div class="bg-slate-800 text-white p-5 rounded-lg shadow flex justify-between items-center">
                        <div>
                            <p class="text-slate-400 text-xs font-bold uppercase tracking-wider">Κερδος / m²</p>
                            <p class="text-xs text-slate-400 mt-1">(Καθαρό Κέρδος)</p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-green-400" id="res-profitPerSqm">€0</p>
                            <p class="text-xs text-slate-400">ανά δομήσιμο μέτρο</p>
                        </div>
                    </div>
                </div>

                <!-- Build Potential Stats (NEW SECTION) -->
                <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
                    
                    <!-- Buildable Area (Above Strength) -->
                    <div class="md:col-span-3 bg-indigo-900 text-white p-5 rounded-xl shadow-lg flex justify-between items-center">
                        <div>
                            <p class="text-indigo-200 text-xs font-bold uppercase tracking-wider">Δομησιμα Μετρα</p>
                            <p class="text-xs text-indigo-300 mt-1">(Σ.Δ.)</p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-white" id="res-buildableArea">0 m²</p>
                        </div>
                    </div>

                    <!-- Max Coverage (Above Risk) -->
                    <div class="md:col-span-2 bg-indigo-900 text-white p-5 rounded-xl shadow-lg flex justify-between items-center">
                        <div>
                            <p class="text-indigo-200 text-xs font-bold uppercase tracking-wider">Μεγιστη Καλυψη</p>
                            <p class="text-xs text-indigo-300 mt-1">(% Οικοπέδου)</p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-white" id="res-coverageArea">0 m²</p>
                        </div>
                    </div>
                </div>

                <!-- Strength Meter & Risk Circle Row -->
                <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
                    
                    <!-- Investment Strength Meter (Indicator Style) -->
                    <div class="md:col-span-3 bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-md font-bold text-gray-700 mb-4 flex items-center gap-2">
                            <i data-lucide="gauge" class="w-5 h-5 text-indigo-600"></i> 
                            Δυναμική Επένδυσης (Strength)
                        </h3>
                        
                        <div class="relative pt-6 pb-2">
                            <div class="flex justify-between mb-2">
                                <span class="text-sm font-medium text-gray-500">Ρίσκο (0%)</span>
                                <span class="text-xl font-black transition-colors duration-300" id="strength-label">--</span>
                                <span class="text-sm font-medium text-gray-500">Ευκαιρία (100%)</span>
                            </div>

                            <div class="h-8 w-full strength-gradient rounded-full shadow-inner relative border border-gray-300">
                                <div id="strength-marker" class="absolute top-0 bottom-0 w-3 bg-black rounded-lg shadow-xl transition-all duration-700 ease-out border-2 border-white/20 transform -translate-x-1/2" style="left: 0%"></div>
                            </div>
                            
                            <div class="flex justify-between text-xs text-gray-400 mt-2 px-1">
                                <span>0%</span>
                                <span>25%</span>
                                <span>50%</span>
                                <span>75%</span>
                                <span>100%</span>
                            </div>

                            <div class="mt-4 text-center">
                                <p class="text-sm text-gray-600">Απόδοση ROI: <span class="font-bold text-indigo-600" id="strength-roi-val">0%</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Circle (Gauge) -->
                    <div class="md:col-span-2 bg-white rounded-xl shadow-lg p-6 flex flex-col items-center">
                        <h3 class="text-md font-bold text-gray-700 mb-2 flex items-center gap-2">
                            <i data-lucide="alert-triangle" class="w-5 h-5 text-orange-500"></i> 
                            Εκτίμηση Ρίσκου
                        </h3>
                        <div class="h-40 w-full relative flex justify-center items-center">
                            <canvas id="riskChart"></canvas>
                            <!-- Center Text overlay for Gauge -->
                            <div class="absolute inset-0 flex items-center justify-center top-8 pointer-events-none">
                                <span id="risk-text" class="text-xl font-bold text-gray-600">--</span>
                            </div>
                        </div>
                        <p class="text-xs text-center text-gray-400 mt-0">Βάσει περιθωρίου κέρδους</p>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <!-- Pie Chart 1: Cost Breakdown -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-md font-bold text-gray-700 mb-4 flex items-center gap-2">
                            <i data-lucide="pie-chart" class="w-4 h-4"></i> Ανάλυση Κόστους
                        </h3>
                        <div class="h-64 relative w-full flex justify-center">
                            <canvas id="costChart"></canvas>
                        </div>
                    </div>

                    <!-- Pie Chart 2: Revenue Breakdown -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-md font-bold text-gray-700 mb-4 flex items-center gap-2">
                            <i data-lucide="circle-dollar-sign" class="w-4 h-4 text-green-600"></i> Κόστος vs Κέρδος
                        </h3>
                        <div class="h-64 relative w-full flex justify-center">
                            <canvas id="revenueChart"></canvas>
                        </div>
                        <p class="text-xs text-center text-gray-400 mt-2">Κατανομή των συνολικών εσόδων</p>
                    </div>
                </div>

            </div>
        </main>
        
        <!-- Footer with User ID info -->
        <footer class="max-w-7xl mx-auto w-full mt-8 p-6 border-t border-gray-200 text-center text-sm text-gray-500">
            <div class="flex flex-col gap-2 mb-4">
                <p class="font-medium text-gray-800">Η εφαρμογή αυτή είναι σχεδιασμένη και φτιαγμένη από τον Θανάση Αθανασόπουλο</p>
                <p class="text-gray-600">This application is designed and built by Thanasis Athanasopoulos</p>
                <a href="mailto:sakissystems@gmail.com" class="text-indigo-600 font-bold hover:underline">sakissystems@gmail.com</a>
            </div>
            
            <div class="flex flex-col items-center justify-center gap-2 mt-4">
                <!-- INFO BUTTON -->
                <button id="infoBtn" class="flex items-center gap-2 px-4 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-full text-xs font-semibold transition-colors border border-gray-300">
                    <i data-lucide="info" class="w-3 h-3"></i> Ταυτότητα Εφαρμογής (Project Info)
                </button>

                <div class="mt-2 text-xs text-gray-400">
                    <p>Real Estate Investment Calculator</p>
                    <p class="mt-1">User: <span id="userIdDisplay" class="font-bold text-indigo-600">--</span></p>
                </div>
            </div>
        </footer>
    </div>

    <script type="module">
        // --- 1. Initialize Icons ---
        lucide.createIcons();

        // --- 2. Chart Instances (Global) ---
        let costChartInstance = null;
        let revenueChartInstance = null;
        let riskChartInstance = null;

        // --- 3. Firebase Setup ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Added 'signInWithEmailAndPassword' and 'signOut'
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
             ? JSON.parse(__firebase_config) 
             : {
                 apiKey: import.meta.env.VITE_API_KEY,
                 authDomain: import.meta.env.VITE_AUTH_DOMAIN,
                 projectId: import.meta.env.VITE_PROJECT_ID,
                 storageBucket: import.meta.env.VITE_STORAGE_BUCKET,
                 messagingSenderId: import.meta.env.VITE_MESSAGING_SENDER_ID,
                 appId: import.meta.env.VITE_APP_ID,
                 measurementId: import.meta.env.VITE_MEASUREMENT_ID
             };

        // --- Init Firebase ---
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Init Error (Check .env file):", e);
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- UI Reference Elements ---
        const loginScreen = document.getElementById('login-screen');
        const appContent = document.getElementById('app-content');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const loginErrorText = document.getElementById('loginErrorText');
        const logoutBtn = document.getElementById('logoutBtn');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // Main App Elements
        let currentUser = null;
        let currentDocId = null;

        const saveBtn = document.getElementById('saveBtn');
        const historyBtn = document.getElementById('historyBtn');
        const resetBtn = document.getElementById('resetBtn');
        const activeProjectIndicator = document.getElementById('activeProjectIndicator');

        // --- AUTHENTICATION LOGIC ---
        if (auth) {
            onAuthStateChanged(auth, (user) => {
                // *** ΝΕΟΣ ΕΛΕΓΧΟΣ ***
                // Αν ο χρήστης είναι Ανώνυμος (από παλιά συνεδρία), τον κάνουμε logout αμέσως.
                if (user && user.isAnonymous) {
                    console.log("Βρέθηκε παλιά ανώνυμη σύνδεση. Γίνεται αποσύνδεση...");
                    signOut(auth);
                    return;
                }
                
                if (user) {
                    // User is Logged In
                    currentUser = user;
                    userIdDisplay.textContent = user.email || user.uid;
                    
                    // Show App, Hide Login
                    loginScreen.classList.add('hidden');
                    appContent.classList.remove('hidden');
                    appContent.classList.add('flex'); // Restore flex layout
                    
                    // Enable buttons
                    saveBtn.disabled = false;
                    historyBtn.disabled = false;
                    
                    lucide.createIcons(); // Re-render icons just in case
                } else {
                    // User is Logged Out
                    currentUser = null;
                    userIdDisplay.textContent = "Αποσυνδέθηκε";
                    
                    // Show Login, Hide App
                    loginScreen.classList.remove('hidden');
                    appContent.classList.add('hidden');
                    appContent.classList.remove('flex');

                    // Disable buttons
                    saveBtn.disabled = true;
                    historyBtn.disabled = true;
                }
            });
        }

        // --- LOGIN ACTION ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtnSubmit');
            const originalBtnContent = btn.innerHTML;

            // Reset Error
            loginError.classList.add('hidden');
            
            // Loading State
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-5 h-5"></i>';
            btn.disabled = true;
            lucide.createIcons();

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle the redirect
            } catch (error) {
                console.error("Login Error:", error);
                
                let msg = "Αποτυχία σύνδεσης.";
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    msg = "Λάθος email ή κωδικός.";
                } else if (error.code === 'auth/too-many-requests') {
                    msg = "Πολλές αποτυχημένες προσπάθειες. Δοκιμάστε αργότερα.";
                }

                loginErrorText.textContent = msg;
                loginError.classList.remove('hidden');
                
                // Reset Button
                btn.innerHTML = originalBtnContent;
                btn.disabled = false;
                lucide.createIcons();
            }
        });

        // --- LOGOUT ACTION ---
        logoutBtn.addEventListener('click', () => {
            if(confirm("Θέλετε σίγουρα να αποσυνδεθείτε;")) {
                signOut(auth);
            }
        });

        // --- SAVE Function ---
        saveBtn.addEventListener('click', async () => {
            if (!currentUser) return;

            // Validation
            const requiredIds = [
                'projectName', 
                'plotSize', 
                'plotPrice', 
                'buildFactor', 
                'coverageFactor', 
                'costPerSqm', 
                'sellPricePerSqm'
            ];
            let missingFields = false;

            requiredIds.forEach(id => {
                const el = document.getElementById(id);
                if (!el.value.trim()) {
                    el.classList.add('input-error');
                    missingFields = true;
                    el.addEventListener('input', () => {
                        el.classList.remove('input-error');
                    }, { once: true });
                } else {
                    el.classList.remove('input-error');
                }
            });

            if (missingFields) {
                showToast("Παρακαλώ συμπληρώστε όλα τα υποχρεωτικά πεδία!", "error");
                return;
            }

            // Collect Data
            const projectName = document.getElementById('projectName').value || "Ανώνυμο Project";
            
            const address = {
                street: document.getElementById('addrStreet').value,
                number: document.getElementById('addrNum').value,
                area: document.getElementById('addrArea').value,
                dimos: document.getElementById('addrDimos').value
            };

            const plotSize = parseFloat(document.getElementById('plotSize').value) || 0;
            const plotPrice = parseFloat(document.getElementById('plotPrice').value) || 0;
            const buildFactor = parseFloat(document.getElementById('buildFactor').value) || 0;
            const coverageFactor = parseFloat(document.getElementById('coverageFactor').value) || 0;
            const costPerSqm = parseFloat(document.getElementById('costPerSqm').value) || 0;
            const sellPricePerSqm = parseFloat(document.getElementById('sellPricePerSqm').value) || 0;

            const buildableArea = plotSize * buildFactor;
            const constructionCost = buildableArea * costPerSqm;
            const totalInvestment = plotPrice + constructionCost;
            const totalRevenue = buildableArea * sellPricePerSqm;
            const grossProfit = totalRevenue - totalInvestment;

            const data = {
                projectName: projectName,
                address: address,
                inputs: {
                    plotSize, plotPrice, buildFactor, coverageFactor, costPerSqm, sellPricePerSqm
                },
                results: {
                    totalInvestment, grossProfit, profitPerSqm: buildableArea > 0 ? grossProfit/buildableArea : 0
                },
                timestamp: serverTimestamp()
            };

            // Loading State
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Αποθήκευση...';
            lucide.createIcons();
            saveBtn.disabled = true;

            try {
                // Using PUBLIC path so data persists across sessions but requires Login now
                const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'calculations'), data);
                currentDocId = docRef.id;
                
                updateActiveProjectUI(projectName);
                showToast("Το project αποθηκεύτηκε επιτυχώς!", "success");

            } catch (error) {
                console.error("Error saving document: ", error);
                showToast("Σφάλμα αποθήκευσης.", "error");
            } finally {
                saveBtn.innerHTML = originalText;
                lucide.createIcons();
                saveBtn.disabled = false;
            }
        });

        // --- RESET Function ---
        resetBtn.addEventListener('click', resetForm);

        function resetForm() {
            document.getElementById('projectName').value = '';
            document.getElementById('addrStreet').value = '';
            document.getElementById('addrNum').value = '';
            document.getElementById('addrArea').value = '';
            document.getElementById('addrDimos').value = '';
            
            document.getElementById('plotSize').value = '';
            document.getElementById('plotPrice').value = '';
            document.getElementById('buildFactor').value = '';
            document.getElementById('coverageFactor').value = '';
            document.getElementById('costPerSqm').value = '';
            document.getElementById('sellPricePerSqm').value = '';
            
            const requiredIds = ['projectName', 'plotSize', 'plotPrice', 'buildFactor', 'coverageFactor', 'costPerSqm', 'sellPricePerSqm'];
            requiredIds.forEach(id => document.getElementById(id).classList.remove('input-error'));

            updateActiveProjectUI("Κανένα");
            currentDocId = null;

            calculate();
            updateMap();
        }

        function updateActiveProjectUI(name) {
            activeProjectIndicator.textContent = name || "Χωρίς Όνομα";
            if (name === "Κανένα") {
                activeProjectIndicator.className = "text-xs font-bold px-2 py-1 bg-gray-200 text-gray-600 rounded";
            } else {
                activeProjectIndicator.className = "text-xs font-bold px-2 py-1 bg-green-100 text-green-700 rounded border border-green-200";
            }
        }

        // --- HISTORY Logic ---
        const modal = document.getElementById('historyModal');
        const modalOverlay = document.querySelector('.modal-overlay');
        const modalClose = document.querySelector('.modal-close');
        const historyTableBody = document.getElementById('historyTableBody');
        const loadingHistory = document.getElementById('loadingHistory');
        const emptyHistory = document.getElementById('emptyHistory');

        // Delete Modal Elements
        const deleteModal = document.getElementById('deleteModal');
        const closeDeleteModalX = document.getElementById('closeDeleteModalX');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        let docIdToDelete = null;

        function toggleModal() {
            const body = document.querySelector('body');
            modal.classList.toggle('opacity-0');
            modal.classList.toggle('pointer-events-none');
            body.classList.toggle('modal-active');
        }

        function toggleDeleteModal() {
            deleteModal.classList.toggle('opacity-0');
            deleteModal.classList.toggle('pointer-events-none');
        }

        modalOverlay.addEventListener('click', toggleModal);
        modalClose.addEventListener('click', toggleModal);

        closeDeleteModalX.addEventListener('click', () => {
            docIdToDelete = null;
            toggleDeleteModal();
        });
        cancelDeleteBtn.addEventListener('click', () => {
            docIdToDelete = null;
            toggleDeleteModal();
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            if (!docIdToDelete || !currentUser) return;

            const originalHtml = confirmDeleteBtn.innerHTML;
            confirmDeleteBtn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Διαγραφή...`;
            confirmDeleteBtn.disabled = true;
            lucide.createIcons();

            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'calculations', docIdToDelete));
                toggleDeleteModal();
                showToast("Η εγγραφή διαγράφηκε.", "success");
                loadHistory(); 
            } catch (error) {
                console.error("Error deleting doc:", error);
                showToast("Σφάλμα διαγραφής.", "error");
            } finally {
                confirmDeleteBtn.innerHTML = originalHtml;
                confirmDeleteBtn.disabled = false;
                lucide.createIcons();
                docIdToDelete = null;
            }
        });

        historyBtn.addEventListener('click', loadHistory);

        async function loadHistory() {
            if (!currentUser) return;
            if (modal.classList.contains('opacity-0')) {
                toggleModal();
            }
            
            historyTableBody.innerHTML = '';
            loadingHistory.classList.remove('hidden');
            emptyHistory.classList.add('hidden');

            try {
                const q = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'calculations'), 
                    orderBy('timestamp', 'desc')
                );
                
                const querySnapshot = await getDocs(q);
                loadingHistory.classList.add('hidden');

                if (querySnapshot.empty) {
                    emptyHistory.classList.remove('hidden');
                    return;
                }

                querySnapshot.forEach((docSnapshot) => {
                    const d = docSnapshot.data();
                    const docId = docSnapshot.id;
                    const date = d.timestamp ? new Date(d.timestamp.seconds * 1000).toLocaleDateString('el-GR') : '-';
                    const inputs = d.inputs || d; 
                    
                    const totalInv = d.results?.totalInvestment || ( (inputs.plotPrice) + ((inputs.plotSize*inputs.buildFactor)*inputs.costPerSqm) );
                    const grossProf = d.results?.grossProfit || ( ( (inputs.plotSize*inputs.buildFactor)*inputs.sellPricePerSqm ) - totalInv );

                    const row = document.createElement('tr');
                    row.className = "border-b border-gray-200 hover:bg-gray-50 cursor-pointer transition-colors"; 
                    
                    row.innerHTML = `
                        <td class="px-4 py-4 text-sm">
                            <p class="text-gray-900 whitespace-no-wrap font-bold">${d.projectName || 'Χωρίς Όνομα'}</p>
                            <p class="text-gray-500 text-xs">${d.address?.street || ''} ${d.address?.area || ''}</p>
                        </td>
                        <td class="px-4 py-4 text-sm text-gray-500">${date}</td>
                        <td class="px-4 py-4 text-sm text-right font-mono">${formatNumber(inputs.plotSize || d.plotSize)}</td>
                        <td class="px-4 py-4 text-sm text-right font-mono text-indigo-600">${formatCurrency(inputs.plotPrice || d.plotPrice)}</td>
                        <td class="px-4 py-4 text-sm text-right font-mono">${inputs.buildFactor || d.buildFactor}</td>
                        <td class="px-4 py-4 text-sm text-right font-mono">${formatCurrency(inputs.costPerSqm || d.costPerSqm)}</td>
                        <td class="px-4 py-4 text-sm text-right font-mono">${formatCurrency(inputs.sellPricePerSqm || d.sellPricePerSqm)}</td>
                        <td class="px-4 py-4 text-sm text-right font-bold text-gray-800 font-mono">${formatCurrency(totalInv)}</td>
                        <td class="px-4 py-4 text-sm text-right font-bold text-green-600 font-mono">${formatCurrency(grossProf)}</td>
                        <td class="px-4 py-4 text-center">
                            <div class="flex items-center justify-center gap-2">
                                <button type="button" class="load-btn p-2 rounded-full text-blue-600 hover:bg-blue-100 transition-colors" title="Φόρτωση">
                                    <i data-lucide="folder-open" class="w-5 h-5 pointer-events-none"></i>
                                </button>
                                <button type="button" class="delete-btn p-2 rounded-full text-red-500 hover:bg-red-100 transition-colors" title="Διαγραφή">
                                    <i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    row.addEventListener('click', () => {
                        populateData(d, docId);
                        toggleModal();
                    });

                    const loadBtn = row.querySelector('.load-btn');
                    loadBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        populateData(d, docId);
                        toggleModal();
                    });

                    const deleteBtn = row.querySelector('.delete-btn');
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        docIdToDelete = docId;
                        toggleDeleteModal();
                    });

                    historyTableBody.appendChild(row);
                });
                lucide.createIcons();

            } catch (error) {
                console.error("Error fetching history:", error);
                loadingHistory.classList.add('hidden');
                historyTableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-red-500">Σφάλμα φόρτωσης.</td></tr>`;
            }
        }

        function populateData(data, docId) {
            currentDocId = docId;
            updateActiveProjectUI(data.projectName);

            const inputs = data.inputs || data;
            const addr = data.address || {};

            document.getElementById('projectName').value = data.projectName || '';
            document.getElementById('addrStreet').value = addr.street || '';
            document.getElementById('addrNum').value = addr.number || '';
            document.getElementById('addrArea').value = addr.area || '';
            document.getElementById('addrDimos').value = addr.dimos || '';

            document.getElementById('plotSize').value = inputs.plotSize || 0;
            document.getElementById('plotPrice').value = inputs.plotPrice || 0;
            document.getElementById('buildFactor').value = inputs.buildFactor || 0;
            document.getElementById('coverageFactor').value = inputs.coverageFactor || 0;
            document.getElementById('costPerSqm').value = inputs.costPerSqm || 0;
            document.getElementById('sellPricePerSqm').value = inputs.sellPricePerSqm || 0;

            calculate();
            updateMap();
        }

        // --- INFO MODAL Logic (NEW) ---
        const infoModal = document.getElementById('infoModal');
        const infoBtn = document.getElementById('infoBtn');
        const closeInfoModalX = document.getElementById('closeInfoModalX');

        function toggleInfoModal() {
            infoModal.classList.toggle('opacity-0');
            infoModal.classList.toggle('pointer-events-none');
            document.querySelector('body').classList.toggle('modal-active');
        }

        infoBtn.addEventListener('click', toggleInfoModal);
        closeInfoModalX.addEventListener('click', toggleInfoModal);
        // Also close when clicking overlay (re-using general logic if desired, or adding specific listener)
        infoModal.querySelector('.modal-overlay').addEventListener('click', toggleInfoModal);


        // --- Helper: Toast ---
        function showToast(msg, type = "success") {
            const toast = document.getElementById('toast');
            const msgSpan = document.getElementById('toast-message');
            const iconContainer = document.getElementById('toast-icon-container');
            
            msgSpan.innerText = msg;
            
            if (type === "error") {
                iconContainer.innerHTML = `<i data-lucide="alert-circle" class="text-red-400 w-5 h-5"></i>`;
            } else {
                iconContainer.innerHTML = `<i data-lucide="check-circle" class="text-green-400 w-5 h-5"></i>`;
            }
            lucide.createIcons(); 

            toast.className = "show flex items-center justify-center gap-2 shadow-xl bg-slate-800";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        }

        // --- Helper Formatters ---
        const formatCurrency = (val) => new Intl.NumberFormat('el-GR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(val);
        const formatNumber = (val) => new Intl.NumberFormat('el-GR', { maximumFractionDigits: 2 }).format(val);

        // --- Main Calculation Function ---
        function calculate() {
            const plotSize = parseFloat(document.getElementById('plotSize').value) || 0;
            const plotPrice = parseFloat(document.getElementById('plotPrice').value) || 0;
            const buildFactor = parseFloat(document.getElementById('buildFactor').value) || 0;
            const coverageFactor = parseFloat(document.getElementById('coverageFactor').value) || 0;
            const costPerSqm = parseFloat(document.getElementById('costPerSqm').value) || 0;
            const sellPricePerSqm = parseFloat(document.getElementById('sellPricePerSqm').value) || 0;

            const buildableArea = plotSize * buildFactor;
            const coverageArea = plotSize * (coverageFactor / 100);
            
            const constructionCost = buildableArea * costPerSqm;
            const totalInvestment = plotPrice + constructionCost;
            
            const totalRevenue = buildableArea * sellPricePerSqm;
            const grossProfit = totalRevenue - totalInvestment;

            const finalCostPerSqm = buildableArea > 0 ? (totalInvestment / buildableArea) : 0;
            const profitPerSqm = buildableArea > 0 ? (grossProfit / buildableArea) : 0;

            const roi = totalInvestment > 0 ? (grossProfit / totalInvestment) * 100 : 0;
            const profitMargin = totalRevenue > 0 ? (grossProfit / totalRevenue) * 100 : 0;

            document.getElementById('res-buildableArea').textContent = formatNumber(buildableArea) + ' m²';
            document.getElementById('res-coverageArea').textContent = formatNumber(coverageArea) + ' m²';
            
            document.getElementById('res-totalInvestment').textContent = formatCurrency(totalInvestment);
            document.getElementById('res-totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('res-grossProfit').textContent = formatCurrency(grossProfit);
            
            document.getElementById('res-finalCostPerSqm').textContent = formatCurrency(finalCostPerSqm);
            document.getElementById('res-profitPerSqm').textContent = formatCurrency(profitPerSqm);

            updateStrengthMeter(roi);
            updateCharts(plotPrice, constructionCost, totalInvestment, grossProfit, profitMargin);
        }

        // --- Strength Meter ---
        function updateStrengthMeter(roi) {
            const marker = document.getElementById('strength-marker');
            const label = document.getElementById('strength-label');
            const roiVal = document.getElementById('strength-roi-val');

            roiVal.textContent = formatNumber(roi) + '%';
            let position = roi; 
            position = Math.min(Math.max(position, 0), 100);
            marker.style.left = position + '%';

            if (roi <= 0) {
                label.textContent = "Ζημιά";
                label.className = "text-xl font-black text-red-600";
            } else if (roi < 15) {
                label.textContent = "Χαμηλή";
                label.className = "text-xl font-black text-orange-500";
            } else if (roi < 30) {
                label.textContent = "Καλή";
                label.className = "text-xl font-black text-yellow-600";
            } else if (roi < 50) {
                label.textContent = "Πολύ Καλή";
                label.className = "text-xl font-black text-lime-600";
            } else {
                label.textContent = "Εξαιρετική!";
                label.className = "text-xl font-black text-green-600";
            }
        }

        // --- Chart Update ---
        function updateCharts(plotPrice, constructionCost, totalInvestment, grossProfit, profitMargin) {
            const costCtx = document.getElementById('costChart').getContext('2d');
            if (costChartInstance) costChartInstance.destroy();
            
            costChartInstance = new Chart(costCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Κόστος Γης', 'Κόστος Κατασκευής'],
                    datasets: [{
                        data: [plotPrice, constructionCost],
                        backgroundColor: ['#6366f1', '#ec4899'], 
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            const revCtx = document.getElementById('revenueChart').getContext('2d');
            if (revenueChartInstance) revenueChartInstance.destroy();

            const visualProfit = grossProfit > 0 ? grossProfit : 0;

            revenueChartInstance = new Chart(revCtx, {
                type: 'pie',
                data: {
                    labels: ['Συνολικό Κόστος', 'Καθαρό Κέρδος'],
                    datasets: [{
                        data: [totalInvestment, visualProfit],
                        backgroundColor: ['#94a3b8', '#22c55e'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw;
                                    const total = context.chart._metasets[context.datasetIndex].total;
                                    const percentage = total > 0 ? Math.round((value / total) * 100) + '%' : '0%';
                                    return ` ${label}: ${formatCurrency(value)} (${percentage})`;
                                }
                            }
                        }
                    }
                }
            });

            let riskScore = 100 - (profitMargin * 2.8);
            riskScore = Math.max(0, Math.min(100, riskScore));
            
            const riskCtx = document.getElementById('riskChart').getContext('2d');
            if (riskChartInstance) riskChartInstance.destroy();

            let riskColor = '#22c55e'; // Green (Low Risk)
            let riskLabelText = 'Χαμηλό';
            
            if (riskScore > 65) {
                riskColor = '#ef4444'; // Red
                riskLabelText = 'Υψηλό';
            } else if (riskScore > 35) {
                riskColor = '#f59e0b'; // Orange
                riskLabelText = 'Μεσαίο';
            }

            document.getElementById('risk-text').textContent = riskLabelText;
            document.getElementById('risk-text').style.color = riskColor;

            riskChartInstance = new Chart(riskCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Ρίσκο', 'Ασφάλεια'],
                    datasets: [{
                        data: [riskScore, 100 - riskScore],
                        backgroundColor: [riskColor, '#e5e7eb'], 
                        borderWidth: 0,
                        circumference: 180, 
                        rotation: 270,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%', 
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            });
        }

        // --- Map Logic ---
        function updateMap() {
            const street = document.getElementById('addrStreet').value.trim();
            const num = document.getElementById('addrNum').value.trim();
            const area = document.getElementById('addrArea').value.trim();
            const dimos = document.getElementById('addrDimos').value.trim();

            if (street || area || dimos) {
                let parts = [];
                if (street) parts.push(street + (num ? ' ' + num : ''));
                if (area) parts.push(area);
                if (dimos) parts.push(dimos);
                parts.push('Greece');
                
                const addressString = parts.join(', ');
                const encodedAddress = encodeURIComponent(addressString);
                
                const iframe = document.getElementById('gmap_canvas');
                iframe.src = `https://maps.google.com/maps?q=${encodedAddress}&t=&z=15&ie=UTF8&iwloc=&output=embed`;
            }
        }

        // --- Event Listeners ---
        const calcInputs = [
            'plotSize', 'plotPrice', 'buildFactor', 'coverageFactor', 'costPerSqm', 'sellPricePerSqm'
        ];
        calcInputs.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.addEventListener('input', calculate);
        });

        const addrInputs = document.querySelectorAll('.address-input');
        addrInputs.forEach(input => {
            input.addEventListener('blur', updateMap);
            input.addEventListener('change', updateMap);
        });

        window.onload = function() {
           calculate();
        }
    </script>
</body>
</html>